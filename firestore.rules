rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isPlayer(sessionId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/sessions/$(sessionId)/players/$(request.auth.uid));
    }

    function isHost(sessionId) {
      return isPlayer(sessionId)
        && get(/databases/$(database)/documents/sessions/$(sessionId)/players/$(request.auth.uid)).data.isHost == true;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // --- Sessions ---
    match /sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isHost(sessionId)
        || (isAuthenticated()
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["playerCount"])
            && request.resource.data.playerCount == resource.data.playerCount + 1);
      allow delete: if isHost(sessionId);

      // --- Players ---
      match /players/{uid} {
        allow read: if isPlayer(sessionId) || isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if isHost(sessionId);
      }

      // --- Rounds ---
      match /rounds/{roundNumber} {
        allow read: if isPlayer(sessionId);
        allow create: if isHost(sessionId);
        allow update: if isHost(sessionId);

        // --- Selections ---
        match /selections/{uid} {
          allow read: if isPlayer(sessionId);
          allow create: if isOwner(uid);
          allow update: if false;
          allow delete: if false;
        }
      }
    }
  }
}
